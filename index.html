<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>Trading Test</title>
        <script src="http://trading-50789.onmodulus.net/socket.io/socket.io.js" type="text/javascript"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
        <link type="text/css" rel="stylesheet" href="./style.css" media="all">
    </head>
    <body>
        <header>
            <h1>Trading Test</h1>
        </header>
         <script type="text/javascript">
            var legendRectSize = 18;
            var legendSpacing = 4;

            var dataset = {
              apples: [53245, 28479, 19697, 24037, 40245],
            };

            var width = 400,
                height = 400,
                radius = Math.min(width, height) / 2;

            var color = d3.scale.category20();

            var pie = d3.layout.pie()
                .sort(null);

            var arc = d3.svg.arc()
                .innerRadius(radius - 100)
                .outerRadius(radius - 50);

            var svg, path;
            $(function() {
                renderGraph();
            });

            function renderGraph() {
                if( d3.select("#donut").length > 0 ) {
                    d3.select("#donut svg").remove();
                }

                svg = d3.select("#donut").append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .append("g")
                    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

                path = svg.selectAll("path")
                    .data(pie(realData))
                    .enter().append("path")
                    .attr("fill", function(d, i) { return color(i); })
                    .attr("d", arc);
                
                var legend = svg.selectAll('.legend')
                    .data(color.domain())
                    .enter()
                    .append('g')
                    .attr('class', 'legend')
                    .attr('transform', function(d, i) {
                        var height = legendRectSize + legendSpacing;
                        var offset =  height * color.domain().length / 2;
                        var horz = -2 * legendRectSize;
                        var vert = i * height - offset;
                        return 'translate(' + horz + ',' + vert + ')';
                    });
                legend.append('rect')
                    .attr('width', legendRectSize)
                    .attr('height', legendRectSize)
                    .style('fill', color)
                    .style('stroke', color);
                legend.append('text')
                    .attr('x', legendRectSize + legendSpacing)
                    .attr('y', legendRectSize - legendSpacing)
                    .text(function(d) { return labels[d]; });
            }
            
        </script>
        <script type="text/javascript">
            var baseSeconds = new Date().getTime() / 60000;
            var socket = io.connect( 'http://trading-50789.onmodulus.net/' );
            var realData = [], labels = []; // for the chart
            socket.connect();
            socket.on( 'message', loadData );

            function loadData( msg ) {
                obj = JSON.parse( msg );
                refresh( obj );
                renderGraph();
            }

            function refresh( obj ) {
                var trans = [];
                var countries = [];
                var i;
                
                for(key in obj.transactions)
                    trans.push( {'name': key, 'value': obj.transactions[key]} );
                trans.sort(compare);

                for(key in obj.countries)
                    countries.push( {'name': key, 'value': obj.countries[key]} );
                countries.sort(compare);

                i = 0;
                $("#totalTrans ol").empty();
                while( i < trans.length && i < 5 ) {
                    $("#totalTrans ol").append( '<li>' + trans[i].name + ': ' + trans[i].value +'</li>' );
                    i++;
                }
                
                i = 0;
                $("#totalCountries ol").empty();
                while( i < countries.length && i < 5 ) {
                    $("#totalCountries ol").append( '<li>' + countries[i].name + ': ' + countries[i].value +'</li>' );
                    i++;
                }
                
                var graph = obj.dataGraph;
                var n = 0;
                realData = [];
                labels = [];
                for( var key in graph ) {
                    if ( graph.hasOwnProperty(key) && key.length > 3 && n < 5 ) {
                        realData.push( graph[key] );
                        labels.push( key );
                    }
                    n++;
                }
            }

            function compare( a, b ) {
                if ( a['value'] < b['value'] )
                    return 1;
                if ( a['value'] > b['value'] )
                    return -1;
                return 0;
            }

            $(document).ready( function() {
                socket.emit( 'getData', "" );
            });
        </script>

        <div id="content">
            <div class="infoLeft">
                <div id="totalTrans" class="panel-heading">
                    <h2>Top transactions per currency</h2>
                    <ol id="trans"></ol>
                </div>

                <div id="totalCountries" class="panel-heading">
                    <h2>Top transactions per country</h2>
                    <ol id="trans"></ol>
                </div>
            </div>
            <div id="donut"></div> 
        </div>

        <footer>
            <P>Juan Carlos Calvo - 2015</P>
        </footer>

    </body>
</html>
